!function(t){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{var i;(i="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this).nipplejs=t()}}(function(){"use strict";var t,i="ontouchstart"in window,e=!!window.PointerEvent,n=!!window.MSPointerEvent,o={touch:{start:"touchstart",move:"touchmove",end:"touchend, touchcancel"},mouse:{start:"mousedown",move:"mousemove",end:"mouseup"},pointer:{start:"pointerdown",move:"pointermove",end:"pointerup, pointercancel"},MSPointer:{start:"MSPointerDown",move:"MSPointerMove",end:"MSPointerUp"}},r={};e?t=o.pointer:n?t=o.MSPointer:i?(t=o.touch,r=o.mouse):t=o.mouse;var s={};function d(){}function p(t,i){return this.identifier=i.identifier,this.position=i.position,this.frontPosition=i.frontPosition,this.collection=t,this.defaults={size:100,threshold:.1,color:"white",fadeTime:250,dataOnly:!1,restJoystick:!0,restOpacity:.5,mode:"dynamic",zone:document.body,lockX:!1,lockY:!1},this.config(i),"dynamic"===this.options.mode&&(this.options.restOpacity=0),this.id=p.id,p.id+=1,this.buildEl().stylize(),this.instance={el:this.ui.el,on:this.on.bind(this),off:this.off.bind(this),show:this.show.bind(this),hide:this.hide.bind(this),add:this.addToDom.bind(this),remove:this.removeFromDom.bind(this),destroy:this.destroy.bind(this),resetDirection:this.resetDirection.bind(this),computeDirection:this.computeDirection.bind(this),trigger:this.trigger.bind(this),position:this.position,frontPosition:this.frontPosition,ui:this.ui,identifier:this.identifier,id:this.id,options:this.options},this.instance}function a(t,i){var e=this;return e.nipples=[],e.idles=[],e.actives=[],e.ids=[],e.pressureIntervals={},e.manager=t,e.id=a.id,a.id+=1,e.defaults={zone:document.body,multitouch:!1,maxNumberOfNipples:10,mode:"dynamic",position:{top:0,left:0},catchDistance:200,size:100,threshold:.1,color:"white",fadeTime:250,dataOnly:!1,restJoystick:!0,restOpacity:.5,lockX:!1,lockY:!1},e.config(i),("static"===e.options.mode||"semi"===e.options.mode)&&(e.options.multitouch=!1),e.options.multitouch||(e.options.maxNumberOfNipples=1),e.updateBox(),e.prepareNipples(),e.bindings(),e.begin(),e.nipples}function c(t){var i,e=this;return e.ids={},e.index=0,e.collections=[],e.config(t),e.prepareCollections(),s.bindEvt(window,"resize",function(t){clearTimeout(i),i=setTimeout(function(){var t,i=s.getScroll();e.collections.forEach(function(e){e.forEach(function(e){t=e.el.getBoundingClientRect(),e.position={x:i.x+t.left,y:i.y+t.top}})})},100)}),e.collections}s.distance=function(t,i){var e=i.x-t.x,n=i.y-t.y;return Math.sqrt(e*e+n*n)},s.angle=function(t,i){var e=i.x-t.x,n=i.y-t.y;return s.degrees(Math.atan2(n,e))},s.findCoord=function(t,i,e){var n={x:0,y:0};return e=s.radians(e),n.x=t.x-i*Math.cos(e),n.y=t.y-i*Math.sin(e),n},s.radians=function(t){return t*(Math.PI/180)},s.degrees=function(t){return t*(180/Math.PI)},s.bindEvt=function(t,i,e){for(var n,o=i.split(/[ ,]+/g),r=0;r<o.length;r+=1)n=o[r],t.addEventListener?t.addEventListener(n,e,!1):t.attachEvent&&t.attachEvent(n,e)},s.unbindEvt=function(t,i,e){for(var n,o=i.split(/[ ,]+/g),r=0;r<o.length;r+=1)n=o[r],t.removeEventListener?t.removeEventListener(n,e):t.detachEvent&&t.detachEvent(n,e)},s.trigger=function(t,i,e){var n=new CustomEvent(i,e);t.dispatchEvent(n)},s.prepareEvent=function(t){return t.preventDefault(),t.type.match(/^touch/)?t.changedTouches:t},s.getScroll=function(){var t;return{x:void 0!==window.pageXOffset?window.pageXOffset:(document.documentElement||document.body.parentNode||document.body).scrollLeft,y:void 0!==window.pageYOffset?window.pageYOffset:(document.documentElement||document.body.parentNode||document.body).scrollTop}},s.applyPosition=function(t,i){i.top||i.right||i.bottom||i.left?(t.style.top=i.top,t.style.right=i.right,t.style.bottom=i.bottom,t.style.left=i.left):(t.style.left=i.x+"px",t.style.top=i.y+"px")},s.getTransitionStyle=function(t,i,e){var n=s.configStylePropertyObject(t);for(var o in n)if(n.hasOwnProperty(o)){if("string"==typeof i)n[o]=i+" "+e;else{for(var r="",d=0,p=i.length;d<p;d+=1)r+=i[d]+" "+e+", ";n[o]=r.slice(0,-2)}}return n},s.getVendorStyle=function(t,i){var e=s.configStylePropertyObject(t);for(var n in e)e.hasOwnProperty(n)&&(e[n]=i);return e},s.configStylePropertyObject=function(t){var i={};return i[t]="",["webkit","Moz","o"].forEach(function(e){i[e+t.charAt(0).toUpperCase()+t.slice(1)]=""}),i},s.extend=function(t,i){for(var e in i)i.hasOwnProperty(e)&&(t[e]=i[e]);return t},s.safeExtend=function(t,i){var e={};for(var n in t)t.hasOwnProperty(n)&&i.hasOwnProperty(n)?e[n]=i[n]:t.hasOwnProperty(n)&&(e[n]=t[n]);return e},s.map=function(t,i){if(t.length)for(var e=0,n=t.length;e<n;e+=1)i(t[e]);else i(t)},d.prototype.on=function(t,i){var e,n=this,o=t.split(/[ ,]+/g);n._handlers_=n._handlers_||{};for(var r=0;r<o.length;r+=1)e=o[r],n._handlers_[e]=n._handlers_[e]||[],n._handlers_[e].push(i);return n},d.prototype.off=function(t,i){var e=this;return e._handlers_=e._handlers_||{},void 0===t?e._handlers_={}:void 0===i?e._handlers_[t]=null:e._handlers_[t]&&e._handlers_[t].indexOf(i)>=0&&e._handlers_[t].splice(e._handlers_[t].indexOf(i),1),e},d.prototype.trigger=function(t,i){var e,n=this,o=t.split(/[ ,]+/g);n._handlers_=n._handlers_||{};for(var r=0;r<o.length;r+=1)e=o[r],n._handlers_[e]&&n._handlers_[e].length&&n._handlers_[e].forEach(function(t){t.call(n,{type:e,target:n},i)})},d.prototype.config=function(t){var i=this;i.options=i.defaults||{},t&&(i.options=s.safeExtend(i.options,t))},d.prototype.bindEvt=function(i,e){var n=this;return n._domHandlers_=n._domHandlers_||{},n._domHandlers_[e]=function(){"function"==typeof n["on"+e]?n["on"+e].apply(n,arguments):console.warn('[WARNING] : Missing "on'+e+'" handler.')},s.bindEvt(i,t[e],n._domHandlers_[e]),r[e]&&s.bindEvt(i,r[e],n._domHandlers_[e]),n},d.prototype.unbindEvt=function(i,e){var n=this;return n._domHandlers_=n._domHandlers_||{},s.unbindEvt(i,t[e],n._domHandlers_[e]),r[e]&&s.unbindEvt(i,r[e],n._domHandlers_[e]),delete n._domHandlers_[e],this},p.prototype=new d,p.constructor=p,p.id=0,p.prototype.buildEl=function(t){return this.ui={},this.options.dataOnly||(this.ui.el=document.createElement("div"),this.ui.back=document.createElement("div"),this.ui.front=document.createElement("div"),this.ui.el.className="nipple collection_"+this.collection.id,this.ui.back.className="back",this.ui.front.className="front",this.ui.el.setAttribute("id","nipple_"+this.collection.id+"_"+this.id),this.ui.el.appendChild(this.ui.back),this.ui.el.appendChild(this.ui.front)),this},p.prototype.stylize=function(){if(this.options.dataOnly)return this;var t=this.options.fadeTime+"ms",i=s.getVendorStyle("borderRadius","50%"),e=s.getTransitionStyle("transition","opacity",t),n={};return n.el={position:"absolute",opacity:this.options.restOpacity,display:"block",zIndex:999},n.back={position:"absolute",display:"block",width:this.options.size+"px",height:this.options.size+"px",marginLeft:-this.options.size/2+"px",marginTop:-this.options.size/2+"px",background:this.options.color,opacity:".5"},n.front={width:this.options.size/2+"px",height:this.options.size/2+"px",position:"absolute",display:"block",marginLeft:-this.options.size/4+"px",marginTop:-this.options.size/4+"px",background:this.options.color,opacity:".5"},s.extend(n.el,e),s.extend(n.back,i),s.extend(n.front,i),this.applyStyles(n),this},p.prototype.applyStyles=function(t){for(var i in this.ui)if(this.ui.hasOwnProperty(i))for(var e in t[i])this.ui[i].style[e]=t[i][e];return this},p.prototype.addToDom=function(){return this.options.dataOnly||document.body.contains(this.ui.el)||this.options.zone.appendChild(this.ui.el),this},p.prototype.removeFromDom=function(){return this.options.dataOnly||!document.body.contains(this.ui.el)||this.options.zone.removeChild(this.ui.el),this},p.prototype.destroy=function(){clearTimeout(this.removeTimeout),clearTimeout(this.showTimeout),clearTimeout(this.restTimeout),this.trigger("destroyed",this.instance),this.removeFromDom(),this.off()},p.prototype.show=function(t){var i=this;return i.options.dataOnly||(clearTimeout(i.removeTimeout),clearTimeout(i.showTimeout),clearTimeout(i.restTimeout),i.addToDom(),i.restCallback(),setTimeout(function(){i.ui.el.style.opacity=1},0),i.showTimeout=setTimeout(function(){i.trigger("shown",i.instance),"function"==typeof t&&t.call(this)},i.options.fadeTime)),i},p.prototype.hide=function(t){var i=this;return i.options.dataOnly||(i.ui.el.style.opacity=i.options.restOpacity,clearTimeout(i.removeTimeout),clearTimeout(i.showTimeout),clearTimeout(i.restTimeout),i.removeTimeout=setTimeout(function(){var e="dynamic"===i.options.mode?"none":"block";i.ui.el.style.display=e,"function"==typeof t&&t.call(i),i.trigger("hidden",i.instance)},i.options.fadeTime),i.options.restJoystick&&i.restPosition()),i},p.prototype.restPosition=function(t){var i=this;i.frontPosition={x:0,y:0};var e=i.options.fadeTime+"ms",n={};n.front=s.getTransitionStyle("transition",["top","left"],e);var o={front:{}};o.front={left:i.frontPosition.x+"px",top:i.frontPosition.y+"px"},i.applyStyles(n),i.applyStyles(o),i.restTimeout=setTimeout(function(){"function"==typeof t&&t.call(i),i.restCallback()},i.options.fadeTime)},p.prototype.restCallback=function(){var t={};t.front=s.getTransitionStyle("transition","none",""),this.applyStyles(t),this.trigger("rested",this.instance)},p.prototype.resetDirection=function(){this.direction={x:!1,y:!1,angle:!1}},p.prototype.computeDirection=function(t){var i,e,n,o=t.angle.radian,r=Math.PI/4,s=Math.PI/2;if(o>r&&o<3*r&&!t.lockX?i="up":o>-r&&o<=r&&!t.lockY?i="left":o>-(3*r)&&o<=-r&&!t.lockX?i="down":t.lockY||(i="right"),t.lockY||(e=o>-s&&o<s?"left":"right"),t.lockX||(n=o>0?"up":"down"),t.force>this.options.threshold){var d={};for(var p in this.direction)this.direction.hasOwnProperty(p)&&(d[p]=this.direction[p]);var a={};for(var p in this.direction={x:e,y:n,angle:i},t.direction=this.direction,d)d[p]===this.direction[p]&&(a[p]=!0);if(a.x&&a.y&&a.angle)return t;a.x&&a.y||this.trigger("plain",t),a.x||this.trigger("plain:"+e,t),a.y||this.trigger("plain:"+n,t),a.angle||this.trigger("dir dir:"+i,t)}return t},a.prototype=new d,a.constructor=a,a.id=0,a.prototype.prepareNipples=function(){var t=this.nipples;t.on=this.on.bind(this),t.off=this.off.bind(this),t.options=this.options,t.destroy=this.destroy.bind(this),t.ids=this.ids,t.id=this.id,t.processOnMove=this.processOnMove.bind(this),t.processOnEnd=this.processOnEnd.bind(this),t.get=function(i){if(void 0===i)return t[0];for(var e=0,n=t.length;e<n;e+=1)if(t[e].identifier===i)return t[e];return!1}},a.prototype.bindings=function(){var t=this;t.bindEvt(t.options.zone,"start"),t.options.zone.style.touchAction="none",t.options.zone.style.msTouchAction="none"},a.prototype.begin=function(){var t=this.options;if("static"===t.mode){var i=this.createNipple(t.position,this.manager.getIdentifier());i.add(),this.idles.push(i)}},a.prototype.createNipple=function(t,i){var e=s.getScroll(),n={},o=this.options;if(t.x&&t.y)n={x:t.x-(e.x+this.box.left),y:t.y-(e.y+this.box.top)};else if(t.top||t.right||t.bottom||t.left){var r=document.createElement("DIV");r.style.display="hidden",r.style.top=t.top,r.style.right=t.right,r.style.bottom=t.bottom,r.style.left=t.left,r.style.position="absolute",o.zone.appendChild(r);var d=r.getBoundingClientRect();o.zone.removeChild(r),n=t,t={x:d.left+e.x,y:d.top+e.y}}var a=new p(this,{color:o.color,size:o.size,threshold:o.threshold,fadeTime:o.fadeTime,dataOnly:o.dataOnly,restJoystick:o.restJoystick,restOpacity:o.restOpacity,mode:o.mode,identifier:i,position:t,zone:o.zone,frontPosition:{x:0,y:0}});return o.dataOnly||(s.applyPosition(a.ui.el,n),s.applyPosition(a.ui.front,a.frontPosition)),this.nipples.push(a),this.trigger("added "+a.identifier+":added",a),this.manager.trigger("added "+a.identifier+":added",a),this.bindNipple(a),a},a.prototype.updateBox=function(){var t=this;t.box=t.options.zone.getBoundingClientRect()},a.prototype.bindNipple=function(t){var i,e=this,n=function(t,n){i=t.type+" "+n.id+":"+t.type,e.trigger(i,n)};t.on("destroyed",e.onDestroyed.bind(e)),t.on("shown hidden rested dir plain",n),t.on("dir:up dir:right dir:down dir:left",n),t.on("plain:up plain:right plain:down plain:left",n)},a.prototype.pressureFn=function(t,i,e){var n=this,o=0;clearInterval(n.pressureIntervals[e]),n.pressureIntervals[e]=setInterval((function(){var e=t.force||t.pressure||t.webkitForce||0;e!==o&&(i.trigger("pressure",e),n.trigger("pressure "+i.identifier+":pressure",e),o=e)}).bind(n),100)},a.prototype.onstart=function(t){var i=this,e=i.options;t=s.prepareEvent(t),i.updateBox();var n=function(t){i.actives.length<e.maxNumberOfNipples&&i.processOnStart(t)};return s.map(t,n),i.manager.bindDocument(),!1},a.prototype.processOnStart=function(t){var i,e=this,n=e.options,o=e.manager.getIdentifier(t),r=t.force||t.pressure||t.webkitForce||0,d={x:t.pageX,y:t.pageY},p=e.getOrCreate(o,d);p.identifier!==o&&e.manager.removeIdentifier(p.identifier),p.identifier=o;var a=function(i){i.trigger("start",i),e.trigger("start "+i.id+":start",i),i.show(),r>0&&e.pressureFn(t,i,i.identifier),e.processOnMove(t)};if((i=e.idles.indexOf(p))>=0&&e.idles.splice(i,1),e.actives.push(p),e.ids.push(p.identifier),"semi"!==n.mode)a(p);else if(s.distance(d,p.position)<=n.catchDistance)a(p);else{p.destroy(),e.processOnStart(t);return}return p},a.prototype.getOrCreate=function(t,i){var e,n=this.options;return/(semi|static)/.test(n.mode)?(e=this.idles[0])?(this.idles.splice(0,1),e):"semi"===n.mode?this.createNipple(i,t):(console.warn("Coudln't find the needed nipple."),!1):this.createNipple(i,t)},a.prototype.processOnMove=function(t){var i=this.options,e=this.manager.getIdentifier(t),n=this.nipples.get(e);if(!n){console.error("Found zombie joystick with ID "+e),this.manager.removeIdentifier(e);return}n.identifier=e;var o=n.options.size/2,r={x:t.pageX,y:t.pageY},d=s.distance(r,n.position),p=s.angle(r,n.position),a=s.radians(p),c=d/o;d>o&&(d=o,r=s.findCoord(n.position,d,p));var l=r.x-n.position.x,h=r.y-n.position.y;i.lockX&&(h=0),i.lockY&&(l=0),n.frontPosition={x:l,y:h},i.dataOnly||s.applyPosition(n.ui.front,n.frontPosition);var f={identifier:n.identifier,position:r,force:c,pressure:t.force||t.pressure||t.webkitForce||0,distance:d,angle:{radian:a,degree:p},instance:n,lockX:i.lockX,lockY:i.lockY};(f=n.computeDirection(f)).angle={radian:s.radians(180-p),degree:180-p},n.trigger("move",f),this.trigger("move "+n.id+":move",f)},a.prototype.processOnEnd=function(t){var i=this,e=i.options,n=i.manager.getIdentifier(t),o=i.nipples.get(n),r=i.manager.removeIdentifier(o.identifier);o&&(e.dataOnly||o.hide(function(){"dynamic"===e.mode&&(o.trigger("removed",o),i.trigger("removed "+o.id+":removed",o),i.manager.trigger("removed "+o.id+":removed",o),o.destroy())}),clearInterval(i.pressureIntervals[o.identifier]),o.resetDirection(),o.trigger("end",o),i.trigger("end "+o.id+":end",o),i.ids.indexOf(o.identifier)>=0&&i.ids.splice(i.ids.indexOf(o.identifier),1),i.actives.indexOf(o)>=0&&i.actives.splice(i.actives.indexOf(o),1),/(semi|static)/.test(e.mode)?i.idles.push(o):i.nipples.indexOf(o)>=0&&i.nipples.splice(i.nipples.indexOf(o),1),i.manager.unbindDocument(),/(semi|static)/.test(e.mode)&&(i.manager.ids[r.id]=r.identifier))},a.prototype.onDestroyed=function(t,i){this.nipples.indexOf(i)>=0&&this.nipples.splice(this.nipples.indexOf(i),1),this.actives.indexOf(i)>=0&&this.actives.splice(this.actives.indexOf(i),1),this.idles.indexOf(i)>=0&&this.idles.splice(this.idles.indexOf(i),1),this.ids.indexOf(i.identifier)>=0&&this.ids.splice(this.ids.indexOf(i.identifier),1),this.manager.removeIdentifier(i.identifier),this.manager.unbindDocument()},a.prototype.destroy=function(){for(var t in this.unbindEvt(this.options.zone,"start"),this.nipples.forEach(function(t){t.destroy()}),this.pressureIntervals)this.pressureIntervals.hasOwnProperty(t)&&clearInterval(this.pressureIntervals[t]);this.trigger("destroyed",this.nipples),this.manager.unbindDocument(),this.off()},c.prototype=new d,c.constructor=c,c.prototype.prepareCollections=function(){var t=this;t.collections.create=t.create.bind(t),t.collections.on=t.on.bind(t),t.collections.off=t.off.bind(t),t.collections.destroy=t.destroy.bind(t),t.collections.get=function(i){var e;return t.collections.every(function(t){return!(e=t.get(i))}),e}},c.prototype.create=function(t){return this.createCollection(t)},c.prototype.createCollection=function(t){var i=new a(this,t);return this.bindCollection(i),this.collections.push(i),i},c.prototype.bindCollection=function(t){var i,e=this,n=function(t,n){i=t.type+" "+n.id+":"+t.type,e.trigger(i,n)};t.on("destroyed",e.onDestroyed.bind(e)),t.on("shown hidden rested dir plain",n),t.on("dir:up dir:right dir:down dir:left",n),t.on("plain:up plain:right plain:down plain:left",n)},c.prototype.bindDocument=function(){var t=this;t.binded||(t.bindEvt(document,"move").bindEvt(document,"end"),t.binded=!0)},c.prototype.unbindDocument=function(t){var i=this;Object.keys(i.ids).length&&!0!==t||(i.unbindEvt(document,"move").unbindEvt(document,"end"),i.binded=!1)},c.prototype.getIdentifier=function(t){var i;return t?void 0===(i=void 0===t.identifier?t.pointerId:t.identifier)&&(i=this.latest||0):i=this.index,void 0===this.ids[i]&&(this.ids[i]=this.index,this.index+=1),this.latest=i,this.ids[i]},c.prototype.removeIdentifier=function(t){var i={};for(var e in this.ids)if(this.ids[e]===t){i.id=e,i.identifier=this.ids[e],delete this.ids[e];break}return i},c.prototype.onmove=function(t){return this.onAny("move",t),!1},c.prototype.onend=function(t){return this.onAny("end",t),!1},c.prototype.oncancel=function(t){return this.onAny("end",t),!1},c.prototype.onAny=function(t,i){var e,n=this,o="processOn"+t.charAt(0).toUpperCase()+t.slice(1);i=s.prepareEvent(i);var r=function(t,i,e){e.ids.indexOf(i)>=0&&(e[o](t),t._found_=!0)},d=function(t){e=n.getIdentifier(t),s.map(n.collections,r.bind(null,t,e)),t._found_||n.removeIdentifier(e)};return s.map(i,d),!1},c.prototype.destroy=function(){var t=this;t.unbindDocument(!0),t.ids={},t.index=0,t.collections.forEach(function(t){t.destroy()}),t.off()},c.prototype.onDestroyed=function(t,i){if(0>this.collections.indexOf(i))return!1;this.collections.splice(this.collections.indexOf(i),1)};var l=new c;return{create:function(t){return l.create(t)},factory:l}});